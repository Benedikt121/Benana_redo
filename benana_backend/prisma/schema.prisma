// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
}

// USER(id, profilePicture, username, hasedpassword, createdAt), kniffel(id, roomid, status{creating, active, finished}, kniffelrounds,
// currentPlayer), kniffelround(id, kniffelid, roundnumber, score, currentPlayer, rolls, usedCategory),
// olympiade(id, roomid, currentRound, status, games, score, winner), olympiadeRound(id, olympiadeid, roundnumber, score, olyGame, winner, addedPoints)
// room(id, players, game, status), games(id, name(kniffel, olympiade))

// --------------------------------------------------------
// USER & SOCIAL
// --------------------------------------------------------

model User {
  id                String   @id @default(uuid())
  username          String   @unique
  passwordHash      String
  profilePictureUrl String?  @default("/public/uploads/default.png")
  createdAt         DateTime @default(now())
  color             String   @default("#ffffff")

  // --- Raum-Logik ---
  
  // Räume, die der User erstellt hat (Host)
  hostedRooms Room[] @relation("RoomHost")

  // Der Raum, in dem der User gerade "sitzt"
  currentRoom   Room?   @relation("CurrentRoomParticipants", fields: [currentRoomId], references: [id])
  currentRoomId String?

  // --- Einladungen & Freunde ---
  
  sentInvitations     Invitation[] @relation("SentInvitations")
  receivedInvitations Invitation[] @relation("ReceivedInvitations")

  friendsAsSender   Friendship[] @relation("FriendshipSender")
  friendsAsReceiver Friendship[] @relation("FriendshipReceiver")

  // --- Statistiken & Spielzüge ---
  
  matchResults MatchResult[] // Generische Ergebnisse (Gewonnen/Verloren/Platz)
  kniffelTurns KniffelTurn[] // Spezifische Kniffel-Züge
}

model Friendship {
  id        String           @id @default(uuid())
  status    InvitationStatus @default(PENDING)
  createdAt DateTime         @default(now())

  sender   User   @relation("FriendshipSender", fields: [senderId], references: [id])
  senderId String

  receiver   User   @relation("FriendshipReceiver", fields: [receiverId], references: [id])
  receiverId String

  @@unique([senderId, receiverId])
}

model Invitation {
  id        String           @id @default(uuid())
  status    InvitationStatus @default(PENDING)
  createdAt DateTime         @default(now())

  sender   User   @relation("SentInvitations", fields: [senderId], references: [id])
  senderId String

  receiver   User   @relation("ReceivedInvitations", fields: [receiverId], references: [id])
  receiverId String

  room   Room   @relation(fields: [roomId], references: [id])
  roomId String
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

// --------------------------------------------------------
// ROOMS & LOBBY
// --------------------------------------------------------

model Room {
  id         String     @id @default(uuid())
  inviteCode String     // Code wird vom Frontend generiert, überprüft und gespeichert
  status     RoomStatus @default(CREATING)
  createdAt  DateTime   @default(now())
  isPublic   Boolean    @default(true)

  // Host des Raumes
  host   User   @relation("RoomHost", fields: [hostId], references: [id])
  hostId String

  // Alle Spieler im Raum
  participants User[] @relation("CurrentRoomParticipants")

  invitations Invitation[]
  matches     Match[]
  olympiades  Olympiade[]
}

enum RoomStatus {
  CREATING
  ACTIVE
  CLOSED
}

// --------------------------------------------------------
// GENERIC GAME LOGIC (Basis für alle Spiele)
// --------------------------------------------------------

model GameDefinition {
  id      String   @id @default(uuid())
  name    String   @unique
  matches Match[]
}

model Match {
  id                String      @id @default(uuid())
  status            MatchStatus @default(PENDING)
  createdAt         DateTime    @default(now())
  endedAt           DateTime?
  currentTurnUserId String?     // Wer ist gerade dran?

  // Verknüpfungen
  room   Room   @relation(fields: [roomId], references: [id])
  roomId String

  gameDefinition   GameDefinition @relation(fields: [gameDefinitionId], references: [id])
  gameDefinitionId String

  // Gehört dieses Match zu einer Olympiade? (Optional)
  olympiade   Olympiade? @relation(fields: [olympiadeId], references: [id])
  olympiadeId String?

  // Ergebnisse
  results MatchResult[]

  // --- SPIEL-SPEZIFISCHE DETAILS ---
  // Hier wird verlinkt, wenn es sich um ein Kniffel-Match handelt
  kniffelGame KniffelGame?
}

enum MatchStatus {
  PENDING
  ACTIVE
  FINISHED
  ABORTED
}

model MatchResult {
  id       String  @id @default(uuid())
  score    Int     // Gesamtpunktzahl im Spiel
  rank     Int?    // Platzierung
  isWinner Boolean @default(false)

  match   Match  @relation(fields: [matchId], references: [id])
  matchId String

  user   User   @relation(fields: [userId], references: [id])
  userId String
}

// --------------------------------------------------------
// OLYMPIADE (Turnier-Logik)
// --------------------------------------------------------

model Olympiade {
  id        String    @id @default(uuid())
  name      String
  status    OlyStatus @default(ACTIVE)
  startedAt DateTime  @default(now())

  room   Room   @relation(fields: [roomId], references: [id])
  roomId String

  // Eine Olympiade besteht aus mehreren Matches
  matches Match[]
}

enum OlyStatus {
  ACTIVE
  FINISHED
}

// --------------------------------------------------------
// KNIFFEL SPEZIFISCHE LOGIK
// --------------------------------------------------------

// Diese Tabelle existiert NUR, wenn das Match ein Kniffel-Spiel ist.
model KniffelGame {
  id       String  @id @default(uuid())
  
  // Die entscheidende Einstellung: Analog oder Digital?
  isAnalog Boolean @default(false) 

  // 1:1 Relation zum generischen Match
  match   Match  @relation(fields: [matchId], references: [id])
  matchId String @unique

  turns KniffelTurn[]
}

model KniffelTurn {
  id          String @id @default(uuid())
  roundNumber Int
  category    String // "ONES", "TWOS", "FULL_HOUSE", etc.
  score       Int    // Die eingetragenen Punkte (auch bei Analog wichtig)
  
  // Bei Analog: null (weil wir die Würfel nicht kennen)
  // Bei Digital: [1, 5, 5, 2, 1]
  rolls       Json?  
  
  rerollCount Int    @default(0) // Nur für Digital relevant

  // Verknüpfung zum KniffelGame (nicht direkt Match, um es sauber zu halten)
  kniffelGame   KniffelGame @relation(fields: [kniffelGameId], references: [id])
  kniffelGameId String

  user   User   @relation(fields: [userId], references: [id])
  userId String
}